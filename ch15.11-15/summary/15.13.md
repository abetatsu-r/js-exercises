## 15.13 ワーカースレッドとメッセージング

JavaScriptは原則シングルスレッドである。しかし、Workerクラスを使うことでこの機能を部分的に緩和することができる。
Workerはdocument、windowオブジェクトにアクセスできない、メインスレッドとは非同期のメッセージパッシングでのみ通信可能などの制約があるが、画像処理などの計算に時間がかかる処理や、頻繁に行われる負荷のかかる処理をマルチスレッドで実行したい場合に有効に活用できる。

### 15.13.1 Workerオブジェクト

Workerコンストラクタを使って、新しいワーカーを作成できる。作成したワーカーに対して`postMessage()`メソッドを呼び出すことでデータを送信することができる。ワーカーからのデータを受け取りたい場合は、messageイベントに対するイベントハンドラを用意する。

### 15.13.2 ワーカーのグローバルオブジェクト

Workerコンストラクタを生成する際にJavascriptのファイルを渡す。この渡されたJavaScriptファイルが実行される環境のGlobalオブジェクトがWorkerGlobalScopeオブジェクトである。Worker同様に、`postMessage()`や`omessage`イベントトリガを持つが、Workerとは方向が逆になる。また、consoleオブジェクトやfetch()といったAPIだけでなく、Workerクラスもサポートされているため、ワーカ内でワーカを作成することも可能となっている。

### 15.13.3 ワーカーへのコードの読み込み

WorkerGlobalScopeには`ImportScripts`が定義されている。`ImportScripts`には複数のURLを渡すことができ、指定されたURLを順に同期的に読み込み実行する。

### 15.14.4 ワーカーの実行モデル

ワーカーは処理を同期的に上から実行したうえで、メッセージの応答などをまつ非同期のフェーズに入る。関連するすべてのコールバック関数が実行されないかぎり、ワーカが勝手に終了することはない。
ワーカ内でエラーが発生した場合、まずワーカのグローバルオブジェクトでエラーが発生する。これでも補足されなかった場合は、ワーカの作成元にerrorイベントとして送信される。

### 15.14.5 postMessage()、MessagePort、MessageChannel

ワーカで用いられるpostMessage()は、MessagePortというクラスを用いて行われている。これはWorker作成時に自動で生成されるもので、クライアントが直接アクセスすることはできない。しかし、MessageChannelを用いることで、新たに一対のMessagePortを作成することはできる。ワーカー間の相互通信や、ArrayBufferを使うコピーせずに転送したい場合に利用される。

### 15.14.6 postMessage()によるクロスオリジンメッセージ

WindowオブジェクトのpostMessage()を使うことで、iframe要素などの異なるウィンドウに対するクロスオリジンなメッセージ送信が可能になる。postMessage()の第二引数には受信する想定の相手のオリジンを指定する。送信されたメッセージはワーカ同様にmessageイベントとして発生する。
